<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kesehatan Mental</title>

  <link rel="stylesheet" href="style.css">

  <style>
    /* ==============================
       BASE OVERRIDES: tetap jaga struktur awal
       ============================== */
    * { box-sizing: border-box; margin:0; padding:0; font-family: "Poppins", "Segoe UI", Roboto, sans-serif; }
    /* Warna font default (Blue/Pink Gradient) akan menggunakan Dark Blue/Pink Gradient */
    body { color: #3a5fbf; line-height:1.6; min-height:100vh; position:relative; overflow-x:hidden; transition: color .4s ease, background-color .3s ease; }

    body::before{
      content: "";
      position: fixed;
      inset: 0;
      z-index: -100;
      background: linear-gradient(135deg, #f7f9ff 0%, #f2f7ff 40%, #fff4fb 100%);
      transition: background .4s ease;
    }

    /* Header - sekarang bergradien biru->pink (tetap kotak) */
    header {
      background: linear-gradient(90deg, #7aa3ff 0%, #ffb3d9 100%);
      padding: 1rem 0;
      text-align: center;
      position: relative;
      overflow: visible;
      transition: background .4s ease;
    }
    header h1 { margin-bottom: 8px; font-size: 1.8rem; color: #3a5fbf; } /* Dark Blue for Default */

    nav ul { list-style:none; display:flex; justify-content:center; gap:18px; flex-wrap:wrap; margin-top:6px; }
    nav ul li a { text-decoration:none; font-weight:600; padding:6px 8px; display:inline-block; color: #3a5fbf; } /* Dark Blue for Default */
    nav ul li a:hover { text-decoration:underline; }

    section { padding: 40px 20px; max-width: 900px; margin: 20px auto; background: transparent; }

    /* H2 - Default to Dark Blue/Pink Gradient */
    h2 {
      margin-bottom:10px;
      transition: all .4s ease; /* Tambahkan transisi untuk tema */
      /* Dark Blue/Pink Gradient for Default H2/Accent */
      background: linear-gradient(90deg, #3a5fbf 0%, #c4407b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
    }

    form { margin-top:20px; background: white; padding:18px; border-radius:12px; box-shadow: 0 6px 18px rgba(30,40,80,0.06); }

    .question { margin-bottom:12px; }
    /* INPUT NUMBER STYLE */
    input[type="number"] {
      padding:8px;
      border-radius:6px;
      border:1px solid #ddd;
      width: 60px; /* Ukuran kecil */
      text-align: center;
      -moz-appearance: textfield; /* Hide arrows in Firefox */
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none; /* Hide arrows in Chrome/Safari */
      margin: 0;
    }
    
    button, .btn {
      background: #9ebdff;
      color:white;
      padding:10px 16px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      position:relative;
      overflow:visible;
      transition: transform .12s ease, box-shadow .12s ease, background .4s ease, color .4s ease;
    }
    button:hover, .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 18px rgba(32,48,120,0.12); }

    #hasil { margin-top:18px; background:#eaf2ff; padding:14px; border-radius:10px; }

    footer { text-align:center; background:transparent; color:inherit; padding:18px 10px; margin-top:40px; }

    .card {
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 18px rgba(30,40,80,0.05);
      height: 100%;
    }

    .question-label {
        color: inherit; /* Pastikan label mengikuti warna body */
    }

    /* Tata letak grid untuk pertanyaan */
    .questions-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:15px; /* Tambah gap */
    }
    /* Style untuk form pertanyaan */
    .question-item {
        display:flex;
        flex-direction:column;
        gap:6px;
    }
    .question-label {
        display:block;
        font-weight:600;
        margin-bottom:4px;
        color: inherit;
    }
    .score-control {
        display:flex;
        gap:8px;
        align-items:center;
    }

    /* RUANG CERITA / STORY BOX STYLES (NEW) */
    #quotes-section { padding: 0; border-radius:12px; background: none; box-shadow: none; }
    
    .story-card {
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 18px rgba(30,40,80,0.05);
      margin-bottom: 25px;
    }
    
    #story-textarea, #topic-select {
      width: 100%; 
      padding: 10px; 
      border-radius: 8px; 
      border: 1px solid #ddd; 
      margin-top: 5px;
      font-family: inherit;
      font-size: 1rem;
      background: white;
    }
    #story-textarea {
        resize: vertical; 
        min-height: 150px;
        margin-bottom: 10px;
    }
    
    /* Response Message Box */
    #response-message {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #7aa3ff; /* Accent blue (Default) */
        background: #f0f7ff;
        color: inherit;
        display: none; /* Hidden by default */
        font-weight: 500;
        transition: all 0.3s ease;
    }

    /* Styles for list of stories */
    .story-list-item {
        margin-bottom: 15px;
        border: 1px solid #eee;
        padding: 15px;
        border-radius: 8px;
        background: white;
        transition: all 0.2s ease;
    }
    .story-list-item:hover {
        box-shadow: 0 4px 12px rgba(30,40,80,0.08);
    }
    .story-list-item h4 {
        margin-bottom: 5px;
        color: inherit;
    }
    .delete-story-btn { background:#ff9999 !important; color:#333 !important; }

    
    /* Theme chooser: DROPDOWN style */
    .theme-chooser {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 6px 0; /* Padding agar sejajar dengan link navigasi */
    }
    .theme-chooser select, #quote-select {
      padding:4px 8px; /* Dikecilkan agar pas di nav */
      border-radius:8px; border:1px solid #ddd; background-color:white; cursor:pointer;
      box-shadow: 0 3px 6px rgba(0,0,0,0.05);
      min-width: 130px;
      appearance: auto;
      font-size: 0.9rem;
    }
    
    /* Style untuk label tema di header (agar mengikuti warna link) */
    header nav .theme-chooser label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #3a5fbf; /* Default Dark Blue */
        white-space: nowrap;
    }

    /* Tab styles for the test section */
    .tab {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        color: #3a5fbf;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
    }
    .tab:hover {
        background: #f0f7ff;
    }
    .tab.active-tab {
        background: linear-gradient(90deg, #7aa3ff 0%, #ffb3d9 100%);
        color: white;
        border-color: transparent;
        font-weight: 600;
    }

    /* ==============================
       THEME STYLES (Color Overrides)
       ============================== */

    /* Pastel Pink Theme */
    body[data-theme="pink"] { color: #c4407b; } /* Dark Pink for all text */
    header[data-theme="pink"] h1, header[data-theme="pink"] nav ul li a, header[data-theme="pink"] nav .theme-chooser label { color: #c4407b; }
    h2[data-theme="pink"] {
        color: #c4407b; /* Darker Pink for headings/accents */
        background: none;
        -webkit-text-fill-color: initial;
        background-clip: initial;
    }
    #response-message[data-theme="pink"] { border-left-color: #ffb3d9; background: #fff4fb; }
    .story-list-item[data-theme="pink"] { border: 1px solid #ffb3d9; }
    .tab[data-theme="pink"] { color: #c4407b; background: white; border-color: #ffb3d9; }
    .tab.active-tab[data-theme="pink"] { background: #ffb3d9; color: white; }

    /* Pastel Blue Theme */
    body[data-theme="blue"] { color: #30538a; } /* Dark Blue for all text */
    header[data-theme="blue"] h1, header[data-theme="blue"] nav ul li a, header[data-theme="blue"] nav .theme-chooser label { color: #30538a; }
    h2[data-theme="blue"] {
        color: #1a407a; /* Darker Blue for headings/accents */
        background: none;
        -webkit-text-fill-color: initial;
        background-clip: initial;
    }
    #response-message[data-theme="blue"] { border-left-color: #7aa3ff; background: #f0f7ff; }
    .story-list-item[data-theme="blue"] { border: 1px solid #7aa3ff; }
    .tab[data-theme="blue"] { color: #30538a; background: white; border-color: #7aa3ff; }
    .tab.active-tab[data-theme="blue"] { background: #7aa3ff; color: white; }

    /* Pastel Purple Theme */
    body[data-theme="purple"] { color: #6a5acd; } /* Dark Purple for all text */
    header[data-theme="purple"] h1, header[data-theme="purple"] nav ul li a, header[data-theme="purple"] nav .theme-chooser label { color: #6a5acd; }
    h2[data-theme="purple"] {
        color: #5533aa; /* Darker Purple for headings/accents */
        background: none;
        -webkit-text-fill-color: initial;
        background-clip: initial;
    }
    #response-message[data-theme="purple"] { border-left-color: #c3a5e8; background: #f7f0ff; }
    .story-list-item[data-theme="purple"] { border: 1px solid #c3a5e8; }
    .tab[data-theme="purple"] { color: #6a5acd; background: white; border-color: #c3a5e8; }
    .tab.active-tab[data-theme="purple"] { background: #c3a5e8; color: white; }
    
    /* Rainbow Theme: Use Default Blue/Pink for static elements */
    body[data-theme="rainbow"] { color: #3a5fbf; } /* Dark Blue/Pink for all text */
    header[data-theme="rainbow"] h1, header[data-theme="rainbow"] nav ul li a, header[data-theme="rainbow"] nav .theme-chooser label { color: #3a5fbf; }
    h2[data-theme="rainbow"] {
        /* Default Gradient */
        background: linear-gradient(90deg, #3a5fbf 0%, #c4407b 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-fill-color: transparent;
    }
    #response-message[data-theme="rainbow"] { border-left-color: #7aa3ff; background: #f0f7ff; }
    .story-list-item[data-theme="rainbow"] { border: 1px solid #7aa3ff; }
    .tab.active-tab[data-theme="rainbow"] { background: linear-gradient(90deg, #7aa3ff 0%, #ffb3d9 100%); }

  </style>

</head>
<body>

  <header>
    <div class="s1" aria-hidden="true"></div>
    <div class="s2" aria-hidden="true"></div>
    <div class="s3" aria-hidden="true"></div>
    <h1>Kesehatan Mental</h1>
    <nav>
      <ul>
        <li><a href="#pencegahan">Pencegahan</a></li>
        <li><a href="#tanda">Tanda-tanda</a></li>
        <li><a href="#mengatasi">Mengatasi</a></li>
        <li><a href="#angket">Tes Mental</a></li>
        <li><a href="#quotes">Ruang Cerita</a></li>
        <li class="theme-menu-item">
            <div class="theme-chooser">
                <label for="theme-select">Tema:</label>
                <select id="theme-select" aria-label="Pilih tema warna">
                    <option value="default">Default (Blue/Pink)</option>
                    <option value="pink">Pastel Pink</option>
                    <option value="blue">Pastel Blue</option>
                    <option value="purple">Pastel Purple</option>
                    <option value="rainbow">Gradient Rainbow</option>
                </select>
            </div>
        </li>
      </ul>
    </nav>
  </header>

  <section id="pencegahan">
    <h2 id="h2-pencegahan">Cara Pencegahan Gangguan Mental</h2>
    <ul>
        <li>Menjaga keseimbangan antara pekerjaan dan istirahat.</li>
        <li>Berolahraga secara teratur.</li>
        <li>Mengonsumsi makanan sehat dan bergizi.</li>
        <li>Tidur yang cukup.</li>
        <li>Melakukan kegiatan yang disukai atau menjadi hobi.</li>
        <li>Mencari dukungan dari orang terdekat.</li>
        <li>Membatasi konsumsi alkohol atau zat adiktif lainnya.</li>
        <li>Belajar mengelola stres dengan baik.</li>
    </ul>
  </section>

  <section id="tanda">
    <h2 id="h2-tanda">Tanda-tanda Gangguan Mental</h2>
    <div class="card">
        <h3>Tanda Peringatan Dini</h3>
        <ul>
            <li>Perubahan suasana hati yang drastis (cepat marah, sedih berlebihan).</li>
            <li>Kesulitan berkonsentrasi atau mengingat sesuatu.</li>
            <li>Merasa lelah terus-menerus tanpa alasan fisik.</li>
            <li>Perubahan kebiasaan tidur (insomnia atau tidur berlebihan).</li>
            <li>Menarik diri dari kegiatan sosial.</li>
            <li>Munculnya pikiran atau perilaku yang merugikan diri sendiri atau orang lain.</li>
        </ul>
    </div>
  </section>

  <section id="mengatasi">
    <h2 id="h2-mengatasi">Cara Mengatasi Gangguan Mental</h2>
    <div class="card">
        <h3>Langkah Penting</h3>
        <ul>
            <li>**Pencarian Bantuan Profesional:** Konsultasi dengan psikolog atau psikiater adalah langkah paling efektif.</li>
            <li>**Dukungan Sosial:** Berbicara dengan keluarga, teman, atau kelompok dukungan.</li>
            <li>**Gaya Hidup Sehat:** Pertahankan pola makan, tidur, dan olahraga yang teratur.</li>
            <li>**Teknik Relaksasi:** Coba meditasi, yoga, atau latihan pernapasan.</li>
            <li>**Tetapkan Batasan:** Belajar mengatakan 'tidak' dan hindari sumber stres yang tidak perlu.</li>
        </ul>
    </div>
  </section>

  <section id="angket">
    <h2 id="h2-angket">Tes Kesehatan Mental</h2>
    <div class="tab-container">
        <div class="tab-header" style="display:flex; gap:10px; margin-bottom: 20px;">
            <button class="tab active-tab" data-tab-for="stres">Tes Stres</button>
            <button class="tab" data-tab-for="kebahagiaan">Tes Kebahagiaan</button>
        </div>

        <div class="test-panel-container">
            <div class="test-panel" data-testpanel="stres" style="display: block;">
                <h3>Tes Stres: Skala Perceived Stress (PSS-10)</h3>
                <form class="test-form" data-test-type="stres">
                    <div class="questions-grid" data-question-key="stres">
                        </div>
                    <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-start;">
                        <button type="submit">Hitung Hasil</button>
                        <button type="button" class="btn" id="saveLocal-stres">Simpan Hasil <span class="hover-ico">â™¡</span></button>
                        <button type="button" class="btn" id="downloadResult-stres" style="background:#fff;color:#333;border:1px solid #eee;">Download <span class="hover-ico">âœ¨</span></button>
                    </div>
                </form>
                <div id="hasil-stres" class="hasil-display" style="margin-top:18px; display:none;"></div>
            </div>

            <div class="test-panel" data-testpanel="kebahagiaan" style="display: none;">
                <h3>Tes Kebahagiaan: Skala Subjective Happiness (SHS)</h3>
                <form class="test-form" data-test-type="kebahagiaan">
                    <div class="questions-grid" data-question-key="kebahagiaan">
                        </div>
                    <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-start;">
                        <button type="submit">Hitung Hasil</button>
                        <button type="button" class="btn" id="saveLocal-kebahagiaan">Simpan Hasil <span class="hover-ico">â™¡</span></button>
                        <button type="button" class="btn" id="downloadResult-kebahagiaan" style="background:#fff;color:#333;border:1px solid #eee;">Download <span class="hover-ico">âœ¨</span></button>
                    </div>
                </form>
                <div id="hasil-kebahagiaan" class="hasil-display" style="margin-top:18px; display:none;"></div>
            </div>
        </div>
    </div>
</section>

<section id="quotes" style="max-width:980px;margin:30px auto;">
    <h2 id="h2-quotes">Ruang Cerita</h2>
    <div id="quotes-section">
        <div class="story-card" id="story-input-card">
            <h3 style="margin-bottom: 15px; color:inherit;">Tulis Cerita atau Curhatmu</h3>
            <form id="story-form">
                <div style="margin-bottom: 15px;">
                    <label for="topic-select" style="font-weight: 600; display: block; margin-bottom: 5px;">Pilih Topik:</label>
                    <select id="topic-select">
                        <option value="umum">Umum</option>
                        <option value="pekerjaan">Pekerjaan/Pendidikan</option>
                        <option value="keluarga">Keluarga</option>
                        <option value="hubungan">Hubungan</option>
                        <option value="kesehatan">Kesehatan</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                </div>
                <textarea id="story-textarea" placeholder="Tuliskan ceritamu di sini (maks. 500 karakter)..." maxlength="500"></textarea>
                <button type="submit" id="save-story-btn">Simpan Cerita</button>
            </form>
            <div id="response-message" style="display: none;"></div>
        </div>
        
        <div class="story-card" id="story-list-card">
            <h3 style="margin-bottom: 15px; color:inherit; display: flex; justify-content: space-between; align-items: center;">
                Semua Cerita Tersimpan 
                <button class="btn delete-story-btn" id="clear-all-stories" style="font-size:0.8rem; padding: 5px 10px; margin:0;">Hapus Semua</button>
            </h3>
            <div id="story-list">
                <p style="text-align:center; font-style:italic;" id="no-stories-message">Belum ada cerita tersimpan.</p>
            </div>
        </div>
    </div>
</section>

<footer>
    <p>&#169; 2024 Kesehatan Mental App. Dibuat dengan niat baik.</p>
</footer>

<script>
    // Data Pertanyaan Tes: 1-5 (1=Sangat Jarang/Tidak Setuju, 5=Sangat Sering/Sangat Setuju)
    const questionsList = {
        stres: [
            "Seberapa sering Anda merasa terganggu oleh sesuatu yang terjadi secara tak terduga?",
            "Seberapa sering Anda merasa tidak dapat mengendalikan hal-hal penting dalam hidup Anda?",
            "Seberapa sering Anda merasa gugup dan stres?",
            "Seberapa sering Anda berhasil mengatasi masalah dan kesulitan pribadi yang mengganggu?",
            "Seberapa sering Anda merasa bahwa Anda secara efektif mengelola hal-hal penting yang ada di hidup Anda?",
            "Seberapa sering Anda merasa yakin dengan kemampuan Anda untuk menangani masalah pribadi?",
            "Seberapa sering Anda merasa bahwa segala sesuatunya berjalan sesuai keinginan Anda?",
            "Seberapa sering Anda merasa tidak dapat mengatasi semua hal yang harus Anda lakukan?",
            "Seberapa sering Anda merasa teriritasi karena hal-hal kecil yang berada di luar kendali Anda?",
            "Seberapa sering Anda merasa bahwa Anda menumpuk kesulitan yang tidak dapat Anda atasi?"
        ],
        kebahagiaan: [
            "Secara umum, saya menganggap diri saya sebagai orang yang:",
            "Dibandingkan dengan teman-teman saya, saya menganggap diri saya:",
            "Beberapa orang pada umumnya adalah orang yang sangat bahagia. Mereka menikmati hidup apa adanya, dan selalu bisa tersenyum. Sejauh mana deskripsi ini menggambarkan diri Anda?",
            "Beberapa orang pada umumnya tidak terlalu bahagia. Meskipun mereka tidak depresi, mereka tidak pernah bahagia seperti yang mereka inginkan. Sejauh mana deskripsi ini menggambarkan diri Anda?"
        ],
        // Tambahkan tes lain di sini jika ada. Contoh: kecemasan, depresi, tidur, dll.
    };

    // Fungsi Perhitungan Hasil Tes (stres) - Skor tinggi = tingkat stres tinggi (0-40, 0=sehat 40=tinggi)
    function handleStressTest(total, questions) {
        // PSS-10: Questions 4, 5, 6, 7 are reverse-scored (5->1, 4->2, 3->3, 2->4, 1->5)
        // Since we already did the reverse scoring during the form submission calculation,
        // the `total` here represents the final PSS score (range 0 to 40).
        
        // PSS-10 is scored 0 to 40. We can map this to a "Healthy Percentage" inversely.
        const maxScore = 40;
        const minScore = 0;
        
        // Invert the PSS score for display as "Healthy Percentage"
        const healthyPercent = Math.round(((maxScore - total) / (maxScore - minScore)) * 100);

        let emoji = '';
        let title = '';
        let interp = '';

        if (total >= 0 && total <= 13) {
            emoji = 'ðŸ˜Œ';
            title = 'Stres Rendah';
            interp = 'Tingkat stres Anda tergolong rendah. Pertahankan gaya hidup seimbang ini.';
        } else if (total >= 14 && total <= 26) {
            emoji = 'ðŸ˜';
            title = 'Stres Sedang';
            interp = 'Anda mengalami tingkat stres sedang. Perhatikan gejala dan lakukan teknik relaksasi rutin.';
        } else if (total >= 27 && total <= 40) {
            emoji = 'ðŸ˜¨';
            title = 'Stres Tinggi';
            interp = 'Tingkat stres Anda tinggi. Segera cari dukungan profesional dan prioritaskan perawatan diri.';
        } else {
             // Should not happen, but for safety
             emoji = 'â“';
             title = 'Tidak Terdefinisi';
             interp = 'Skor tidak valid.';
        }
        
        return { emoji, title, interp, healthyPercent, resultMessage: 'Tingkat Stres' };
    }

    // NEW FUNCTION: Fungsi Perhitungan Hasil Tes (kebahagiaan) - Skor tinggi = tingkat kebahagiaan tinggi (4-20, 4=rendah 20=tinggi)
    function handleHappyTest(total, questions) {
        // Subjective Happiness Scale (SHS) - higher raw score (total) means better (healthier).
        // The total score ranges from 4*1 (4) to 4*7 (28) but the input is 1-5, so it's 4*1 (4) to 4*5 (20).
        // Let's assume input 1-5 for 4 questions: Min 4, Max 20.
        const happinessScore = total; 
        const min = questions * 1; // 4
        const max = questions * 5; // 20
        
        // Calculate percentage of the maximum possible score range
        const happyPercent = Math.round(((happinessScore - min) / (max - min)) * 100);

        let emoji = '';
        let title = '';
        let interp = '';

        if (happyPercent >= 80) {
            emoji = 'ðŸ¤©';
            title = 'Sangat Bahagia';
            interp = 'Kamu merasa sangat bahagia. Pertahankan rasa syukur dan kebiasaan positif.';
        } else if (happyPercent >= 50) {
            emoji = 'ðŸ˜Š';
            title = 'Cukup Bahagia';
            interp = 'Kamu cukup bahagia. Coba rutinitas kecil yang membahagiakan untuk meningkatkannya.';
        } else {
            emoji = 'ðŸ˜•';
            title = 'Kurang Bahagia';
            interp = 'Pertimbangkan aktivitas yang memberi makna dan meningkatkan hubungan sosial.';
        }

        // healthyPercent is the happyPercent in this context
        return { emoji, title, interp, healthyPercent: happyPercent, resultMessage: 'Tingkat Kebahagiaan' }; 
    }

    /**********************
     * Render questions into each panel (Using INPUT TYPE="NUMBER")
     **********************/
    function renderQuestions() {
        document.querySelectorAll('.test-panel').forEach(panel => {
            const grid = panel.querySelector('.questions-grid');
            const qKey = grid.dataset.questionKey;
            const questions = questionsList[qKey];
            
            if (questions && grid) {
                grid.innerHTML = questions.map((q, i) => {
                    const questionNumber = i + 1;
                    const questionId = `${qKey}-q${questionNumber}`;

                    // Set min/max based on the specific question key
                    const minVal = 1;
                    const maxVal = qKey === 'kebahagiaan' ? 5 : 5; // Use 1-5 scale for all
                    const stepVal = 1;

                    return `
                        <div class="question-item">
                            <label for="${questionId}" class="question-label">${questionNumber}. ${q}</label>
                            <div class="score-control">
                                <input type="number" id="${questionId}" name="${questionId}" min="${minVal}" max="${maxVal}" step="${stepVal}" required placeholder="1-5">
                                <span>(1=Terendah, ${maxVal}=Tertinggi)</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        });
    }

    // Call once to render all questions on load
    renderQuestions();


    /**********************
     * Handle form submissions for all tests
     **********************/
    document.querySelectorAll('.test-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            // Use number inputs
            const inputs = Array.from(form.querySelectorAll('input[type="number"]'));

            // Check for required fields and value range
            let total = 0;
            let isValid = true;
            let questions = inputs.length;
            
            inputs.forEach((inp, index) => {
                let v = parseInt(inp.value, 10);
                let qKey = form.querySelector('.questions-grid').dataset.questionKey;

                if (isNaN(v) || v < 1 || v > 5) {
                    isValid = false;
                    inp.style.border = '2px solid red'; // Highlight invalid input
                } else {
                    inp.style.border = '1px solid #ddd'; // Reset border
                    
                    // PSS-10 Reverse Scoring (Stres questions 4, 5, 6, 7 are reversed)
                    // PSS Index is 0-9. Reverse-scored are index 3, 4, 5, 6.
                    if (qKey === 'stres' && (index === 3 || index === 4 || index === 5 || index === 6)) {
                        total += (6 - v); // If v=5 (Sangat Sering), score is 1 (6-5). If v=1, score is 5 (6-1).
                    } else {
                        total += v;
                    }
                }
            });

            if (!isValid) {
                alert("Harap isi semua pertanyaan dengan skor antara 1 sampai 5.");
                return;
            }

            const activePanel = form.closest('.test-panel');
            const testKey = activePanel ? activePanel.dataset.testpanel : 'test';
            
            let result;
            if (testKey === 'stres') {
                result = handleStressTest(total, questions);
            } else if (testKey === 'kebahagiaan') { // NEW LOGIC FOR KEBAHAGIAAN
                result = handleHappyTest(total, questions);
            } else {
                return; // Exit if test key is unknown
            }
            
            // Display results
            const resultDiv = document.getElementById(`hasil-${testKey}`);
            if (resultDiv) {
                const healthyText = `${result.healthyPercent}% sehat`;
                const unhealthyText = `${100 - result.healthyPercent}% tidak sehat`;
                
                // Determine which percentage to display based on test type (Stress is inverted)
                const percentage = result.healthyPercent;
                const progressColor = percentage >= 80 ? 'green' : (percentage >= 50 ? 'orange' : 'red');

                resultDiv.innerHTML = `
                    <div style="font-size: 1.1rem; font-weight: 700; color: inherit; margin-bottom: 8px;">
                        ${result.emoji} ${result.resultMessage}: ${result.title}
                    </div>
                    <p style="margin-bottom: 12px;">**Hasil Anda:** ${result.interp}</p>
                    <div style="font-size: 0.9rem; color: #555;">
                        <p style="margin-bottom: 5px;">${percentage}% dalam kategori sehat (atau bahagia).</p>
                    </div>
                    <div style="background: #eee; border-radius: 5px; height: 10px; overflow: hidden; margin-top: 10px;">
                        <div style="width: ${percentage}%; height: 100%; background: ${progressColor}; transition: width 0.5s ease;"></div>
                    </div>
                `;
                resultDiv.style.display = 'block';
                // Scroll to result
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });

    /**********************
     * TAB SWITCHING LOGIC (NEW/Enhanced)
     **********************/
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            const targetKey = e.currentTarget.dataset.tabFor;
            const allPanels = document.querySelectorAll('.test-panel');

            // 1. Remove 'active-tab' from all tabs and hide all panels
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active-tab'));
            allPanels.forEach(p => p.style.display = 'none');

            // 2. Add 'active-tab' to the clicked tab and show the corresponding panel
            e.currentTarget.classList.add('active-tab');
            const targetPanel = document.querySelector(`.test-panel[data-testpanel="${targetKey}"]`);
            if (targetPanel) {
                targetPanel.style.display = 'block';
            }

            // 3. Optional: Scroll to the top of the section
            document.getElementById('angket').scrollIntoView({ behavior: 'smooth' });
        });
    });

    // --- Story/Quote Logic (Kept as is) ---
    const STORY_STORAGE_KEY = 'mentalHealthStories';
    const responseMessageDiv = document.getElementById('response-message');
    const responseText = document.getElementById('response-message');
    const clearAllBtn = document.getElementById('clear-all-stories');

    function saveStories(stories) {
        localStorage.setItem(STORY_STORAGE_KEY, JSON.stringify(stories));
    }

    function getStories() {
        const stored = localStorage.getItem(STORY_STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
    }
    
    function deleteStory(index) {
        let stories = getStories();
        stories.splice(index, 1);
        saveStories(stories);
        renderStories();
    }
    
    function renderStories() {
        const storyListDiv = document.getElementById('story-list');
        const stories = getStories().reverse(); // Show newest first
        const noStoriesMessage = document.getElementById('no-stories-message');

        if (stories.length === 0) {
            storyListDiv.innerHTML = `<p style="text-align:center; font-style:italic;" id="no-stories-message">Belum ada cerita tersimpan.</p>`;
            clearAllBtn.style.display = 'none';
            return;
        }

        clearAllBtn.style.display = 'inline-block';
        storyListDiv.innerHTML = ''; // Clear existing content

        const currentTheme = document.getElementById('theme-select').value;
        
        stories.forEach((story, originalIndex) => {
            // Calculate the index in the original, non-reversed array for deletion
            const deletionIndex = stories.length - 1 - originalIndex; 

            const item = document.createElement('div');
            item.classList.add('story-list-item');
            
            // Apply theme to list item
            if (currentTheme !== 'default') {
                item.setAttribute('data-theme', currentTheme);
            }
            
            // Format date
            const date = new Date(story.timestamp).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            // Limit content preview
            const preview = story.content.substring(0, 100).replace(/\n/g, ' ') + (story.content.length > 100 ? '...' : '');

            // Determine displayed topic name
            const topicName = story.topic.charAt(0).toUpperCase() + story.topic.slice(1);

            item.innerHTML = `
                <h4 style="margin-bottom: 5px;">[${topicName}] - ${date}</h4>
                <p style="font-size:0.9rem; color:inherit; margin-bottom:10px;">${preview}</p>
                <button class="btn view-story-btn" style="padding: 5px 10px; font-size:0.8rem; margin-right: 8px;">Lihat Penuh</button>
                <button class="btn delete-story-btn" style="padding: 5px 10px; font-size:0.8rem;" data-index="${deletionIndex}">Hapus</button>
            `;

            // Add listener for View Full Story button
            item.querySelector('.view-story-btn').addEventListener('click', () => {
                alert(`Topik: ${topicName}\nTanggal: ${date}\n\nCerita Lengkap:\n${story.content}`);
            });

            // Add listener for Delete button
            item.querySelector('.delete-story-btn').addEventListener('click', (e) => {
                const indexToDelete = parseInt(e.target.dataset.index, 10);
                if (confirm("Apakah Anda yakin ingin menghapus cerita ini?")) {
                    deleteStory(indexToDelete);
                }
            });

            storyListDiv.appendChild(item);
        });
    }

    // Handle Story Form Submission
    document.getElementById('story-form').addEventListener('submit', function (e) {
        e.preventDefault();
        
        const topic = document.getElementById('topic-select').value;
        const content = document.getElementById('story-textarea').value.trim();

        if (content.length < 10) {
            alert("Cerita terlalu pendek. Mohon tulis lebih dari 10 karakter.");
            return;
        }

        let stories = getStories();
        const newStory = {
            topic,
            content,
            timestamp: new Date().toISOString()
        };
        stories.push(newStory);
        saveStories(stories);
        
        // Reset form
        this.reset();
        
        // Render stories list
        renderStories();

        // Show success message
        const currentTheme = document.getElementById('theme-select').value;
        responseText.innerHTML = `
            <h4 style="color:inherit; margin-bottom: 8px;">[Cerita Anda (${new Date(newStory.timestamp).toLocaleDateString()})]:</h4>
            <p style="white-space: pre-wrap; margin-bottom: 12px; font-style:italic; font-size:0.9rem;">${newStory.content}</p>
            <p style="font-weight: 600;">&#10003; Cerita berhasil disimpan! Terima kasih sudah berbagi.</p>
        `;
        responseMessageDiv.setAttribute('data-theme', currentTheme);
        responseMessageDiv.style.display = 'block';

        // Scroll to response message
        responseMessageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Hide message after 5 seconds
        setTimeout(() => {
            responseMessageDiv.style.display = 'none';
        }, 5000);
    });

    // Handle Clear All Stories button
    clearAllBtn.addEventListener('click', () => {
        if (confirm("Apakah Anda yakin ingin MENGHAPUS SEMUA cerita yang tersimpan? Tindakan ini tidak dapat dibatalkan.")) {
            saveStories([]);
            renderStories();
            // Show message
            const currentTheme = document.getElementById('theme-select').value;
            responseText.innerHTML = `<p style="font-weight: 600;">&#10003; Semua cerita berhasil dihapus.</p>`;
            responseMessageDiv.setAttribute('data-theme', currentTheme);
            responseMessageDiv.style.display = 'block';
            setTimeout(() => {
                responseMessageDiv.style.display = 'none';
            }, 3000);
        }
    });

    // --- Theme Logic (Kept as is) ---
    const themeSelect = document.getElementById('theme-select');
    const headerElement = document.querySelector('header');
    const h2Elements = document.querySelectorAll('h2');
    const navLinks = document.querySelectorAll('nav ul li a, header nav .theme-chooser label');
    const quoteAuthor = document.getElementById('quote-author'); // Assuming this element exists for theme

    function applyTheme(theme) {
        // Reset to default
        document.body.removeAttribute('data-theme');
        headerElement.removeAttribute('data-theme');
        h2Elements.forEach(h => h.removeAttribute('data-theme'));
        document.querySelectorAll('button, .btn').forEach(b => b.removeAttribute('data-theme'));
        navLinks.forEach(a => a.removeAttribute('data-theme'));
        responseMessageDiv.removeAttribute('data-theme');
        document.querySelectorAll('.story-list-item').forEach(si => si.removeAttribute('data-theme'));
        document.querySelectorAll('.tab').forEach(t => t.removeAttribute('data-theme')); // New: Tabs

        if (theme !== 'default') {
            document.body.setAttribute('data-theme', theme);
            headerElement.setAttribute('data-theme', theme);
            h2Elements.forEach(h => h.setAttribute('data-theme', theme));
            // Apply to all buttons (including tabs)
            document.querySelectorAll('button, .btn').forEach(b => b.setAttribute('data-theme', theme));
            navLinks.forEach(a => a.setAttribute('data-theme', theme));
            responseMessageDiv.setAttribute('data-theme', theme);
            document.querySelectorAll('.story-list-item').forEach(si => si.setAttribute('data-theme', theme));
            document.querySelectorAll('.tab').forEach(t => t.setAttribute('data-theme', theme)); // New: Tabs
        }
        // Call renderStories to re-apply theme to list items
        renderStories(); 
    }

    themeSelect.addEventListener('change', (e) => {
        applyTheme(e.target.value);
    });

    // Initialize all features on load
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Initialize default theme
        applyTheme(themeSelect.value); 
        // 2. Load and render saved stories (Ruang Cerita)
        renderStories();
    });


    /**********************
     * Extra: small keyboard accessibility for tabs
     **********************/
    document.querySelectorAll('.tab').forEach((t, i, list) => {
      t.setAttribute('tabindex','0');
      t.addEventListener('keydown', (e)=>{
        if (e.key === 'ArrowRight') { list[(i+1)%list.length].focus(); e.preventDefault(); }
        if (e.key === 'ArrowLeft') { list[(i-1+list.length)%list.length].focus(); e.preventDefault(); }
        if (e.key === 'Enter' || e.key === ' ') t.click();
      });
    });

    /**********************
     * Initialize small defaults: set numeric inputs min1
     **********************/
    document.querySelectorAll('input[type="number"]').forEach(inp => {
        if (!inp.hasAttribute('min')) inp.setAttribute('min', '1');
        if (!inp.hasAttribute('max')) inp.setAttribute('max', '5');
        if (!inp.hasAttribute('step')) inp.setAttribute('step', '1');
    });
</script>

</body>
</html>